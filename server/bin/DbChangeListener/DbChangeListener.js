"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const service_starter_1 = require("service-starter");
const _ = require("lodash");
const TriggerType_1 = require("./TriggerType");
class DbChangeListener extends service_starter_1.ServiceModule {
    constructor() {
        super(...arguments);
        this.registeredListener = {};
    }
    get _tableInfo() {
        return this.services.QueryTableInfo.tableInfo;
    }
    get _triggerCreator() {
        return this.services.TriggerCreator;
    }
    async onStart() {
        this.services.ChangedDataReceiver.onData = this._dispatch.bind(this);
    }
    async onStop() {
        this.services.ChangedDataReceiver.onData = undefined;
    }
    async listen(callback, schema, table, type, field) {
        if (type === TriggerType_1.default.update) {
            if (field === undefined)
                throw new Error('update 类型的监听器，未提供要监听的字段（field）');
            this._check_table_and_fields_exists(schema, table, field);
        }
        else {
            this._check_table_and_fields_exists(schema, table);
            field = '-';
        }
        let listener = _.get(this.registeredListener, [schema, table, type, field]);
        if (listener === undefined) {
            listener = new Set();
            listener.add(callback);
            _.set(this.registeredListener, [schema, table, type, field], listener);
            switch (type) {
                case TriggerType_1.default.insert:
                    await this._triggerCreator.createInsertTrigger(schema, table);
                    break;
                case TriggerType_1.default.delete:
                    await this._triggerCreator.createDeleteTrigger(schema, table);
                    break;
                case TriggerType_1.default.update:
                    const fields = Object.keys(_.get(this.registeredListener, [schema, table, type]));
                    await this._triggerCreator.createUpdateTrigger(schema, table, fields);
                    break;
            }
        }
        else {
            if (listener.has(callback))
                throw new Error('相同的回调函数被重复注册');
            listener.add(callback);
        }
    }
    async remove(callback, schema, table, type, field = '_') {
        const listener = _.get(this.registeredListener, [schema, table, type, field]);
        if (listener !== undefined) {
            listener.delete(callback);
            if (listener.size === 0) {
                const target = _.get(this.registeredListener, [schema, table, type]);
                delete target[field];
                switch (type) {
                    case TriggerType_1.default.insert:
                        await this._triggerCreator.removeInsertTrigger(schema, table);
                        break;
                    case TriggerType_1.default.delete:
                        await this._triggerCreator.removeDeleteTrigger(schema, table);
                        break;
                    case TriggerType_1.default.update:
                        const fields = Object.keys(_.get(this.registeredListener, [schema, table, type]));
                        if (fields.length === 0)
                            await this._triggerCreator.removeUpdateTrigger(schema, table);
                        else
                            await this._triggerCreator.createUpdateTrigger(schema, table, fields);
                        break;
                }
            }
        }
    }
    _dispatch(data) {
        const emit = (listener) => {
            if (listener) {
                for (let item of listener.values()) {
                    item(data);
                }
            }
        };
        if (data.type === TriggerType_1.default.update) {
            for (let item of data.changedFields) {
                emit(_.get(this.registeredListener, [data.schema, data.table, data.type, item]));
            }
        }
        else {
            emit(_.get(this.registeredListener, [data.schema, data.table, data.type, '_']));
        }
    }
    _check_table_and_fields_exists(schema, table, field) {
        const tb = _.get(this._tableInfo, [schema, table]);
        if (tb === undefined) {
            throw new Error(`数据库[${schema}] 下的表 [${table}] 不存在，无法创建Trigger`);
        }
        if (field !== undefined) {
            if (tb[field] !== true) {
                throw new Error(`数据库[${schema}] 下的表 [${table}] 下的字段 [${field}] 不存在，无法创建Trigger`);
            }
        }
    }
}
exports.default = DbChangeListener;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRiQ2hhbmdlTGlzdGVuZXIvRGJDaGFuZ2VMaXN0ZW5lci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHFEQUFxRDtBQUNyRCw0QkFBNkI7QUFHN0IsK0NBQXdDO0FBU3hDLHNCQUFzQyxTQUFRLCtCQUFhO0lBQTNEOztRQUdxQix1QkFBa0IsR0FBUSxFQUFFLENBQUM7SUEwSmxELENBQUM7SUF2SkcsSUFBWSxVQUFVO1FBQ2xCLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQUM7SUFDbEQsQ0FBQztJQUVELElBQVksZUFBZTtRQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFnQyxDQUFDO0lBQzFELENBQUM7SUFFRCxLQUFLLENBQUMsT0FBTztRQUNSLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQTJDLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xHLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTTtRQUNQLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQTJDLENBQUMsTUFBTSxHQUFHLFNBQVMsQ0FBQztJQUNsRixDQUFDO0lBV0QsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFxQyxFQUFFLE1BQWMsRUFBRSxLQUFhLEVBQUUsSUFBaUIsRUFBRSxLQUFhO1FBQy9HLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxxQkFBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDOUIsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQztnQkFDcEIsTUFBTSxJQUFJLEtBQUssQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO1lBQ3RELElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxNQUFNLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlELENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNKLElBQUksQ0FBQyw4QkFBOEIs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YkNoYW5nZUxpc3RlbmVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VydmljZU1vZHVsZSwgbG9nIH0gZnJvbSBcInNlcnZpY2Utc3RhcnRlclwiO1xuaW1wb3J0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcblxuaW1wb3J0IENoYW5nZWREYXRhIGZyb20gJy4vQ2hhbmdlZERhdGEnO1xuaW1wb3J0IFRyaWdnZXJUeXBlIGZyb20gJy4vVHJpZ2dlclR5cGUnO1xuaW1wb3J0IENoYW5nZWREYXRhUmVjZWl2ZXIgZnJvbSAnLi9DaGFuZ2VkRGF0YVJlY2VpdmVyJztcbmltcG9ydCBUcmlnZ2VyQ3JlYXRvciBmcm9tICcuL1RyaWdnZXJDcmVhdG9yJztcblxuXG4vKipcbiAqIOaVsOaNruihqOWPmOWMluebkeWQrOWZqOOAgiAgIFxuICog55uR5ZCs5ZyobG9jYWxob3N0OjIyMzNcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRGJDaGFuZ2VMaXN0ZW5lciBleHRlbmRzIFNlcnZpY2VNb2R1bGUge1xuXG4gICAgLy8g5L+d5a2Y5rOo5YaM5LqG55qE55uR5ZCs5ZmoXG4gICAgcHJpdmF0ZSByZWFkb25seSByZWdpc3RlcmVkTGlzdGVuZXI6IGFueSA9IHt9O1xuXG4gICAgLy9teXNxbOihqOS/oeaBr1xuICAgIHByaXZhdGUgZ2V0IF90YWJsZUluZm8oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VzLlF1ZXJ5VGFibGVJbmZvLnRhYmxlSW5mbztcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldCBfdHJpZ2dlckNyZWF0b3IoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlcnZpY2VzLlRyaWdnZXJDcmVhdG9yIGFzIFRyaWdnZXJDcmVhdG9yO1xuICAgIH1cblxuICAgIGFzeW5jIG9uU3RhcnQoKSB7XG4gICAgICAgICh0aGlzLnNlcnZpY2VzLkNoYW5nZWREYXRhUmVjZWl2ZXIgYXMgQ2hhbmdlZERhdGFSZWNlaXZlcikub25EYXRhID0gdGhpcy5fZGlzcGF0Y2guYmluZCh0aGlzKTtcbiAgICB9XG5cbiAgICBhc3luYyBvblN0b3AoKSB7XG4gICAgICAgICh0aGlzLnNlcnZpY2VzLkNoYW5nZWREYXRhUmVjZWl2ZXIgYXMgQ2hhbmdlZERhdGFSZWNlaXZlcikub25EYXRhID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOazqOWGjOaVsOaNruW6k+ihqOS4reWtl+auteWPmOWMlueahOebkeWQrOWZqFxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7KGRhdGE6IENoYW5nZWREYXRhKSA9PiB2b2lkfSBjYWxsYmFjayDlj5HnlJ/lj5jljJblkI7opoHmiafooYznmoTlm57osIPlh73mlbBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2NoZW1hIOimgeebkeWQrOeahOaVsOaNruW6k1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSDopoHnm5HlkKznmoTooahcbiAgICAgKiBAcGFyYW0ge1RyaWdnZXJUeXBlfSB0eXBlIOimgeebkeWQrOeahOexu+Wei1xuICAgICAqIEBwYXJhbSB7c3RyaW5nW119IGZpZWxkIOWmguaenOebkeWQrOeahOexu+Wei+aYr3VwZGF0Ze+8jOmCo+S5iOi/mOimgeaMh+WumuimgeebkeWQrOeahOWtl+auteOAglxuICAgICAqL1xuICAgIGFzeW5jIGxpc3RlbihjYWxsYmFjazogKGRhdGE6IENoYW5nZWREYXRhKSA9PiB2b2lkLCBzY2hlbWE6IHN0cmluZywgdGFibGU6IHN0cmluZywgdHlwZTogVHJpZ2dlclR5cGUsIGZpZWxkOiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKHR5cGUgPT09IFRyaWdnZXJUeXBlLnVwZGF0ZSkge1xuICAgICAgICAgICAgaWYgKGZpZWxkID09PSB1bmRlZmluZWQpXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCd1cGRhdGUg57G75Z6L55qE55uR5ZCs5Zmo77yM5pyq5o+Q5L6b6KaB55uR5ZCs55qE5a2X5q6177yIZmllbGTvvIknKTtcbiAgICAgICAgICAgIHRoaXMuX2NoZWNrX3RhYmxlX2FuZF9maWVsZHNfZXhpc3RzKHNjaGVtYSwgdGFibGUsIGZpZWxkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuX2NoZWNrX3RhYmxlX2FuZF9maWVsZHNfZXhpc3RzKHNjaGVtYSwgdGFibGUpO1xuICAgICAgICAgICAgZmllbGQgPSAnLSc7ICAgIC8vIOS4uuWFtuS7luinpuWPkeWZqOexu+Wei+aPkOS+m+S4gOS4qum7mOiupOWAvFxuICAgICAgICB9XG5cbiAgICAgICAgLy8g5om+5Yiw5a+55bqU55qE5L2N572u77yM5a2Y5pS+55uR5ZCs5ZmoXG4gICAgICAgIGxldCBsaXN0ZW5lcjogU2V0PEZ1bmN0aW9uPiA9IF8uZ2V0KHRoaXMucmVnaXN0ZXJlZExpc3RlbmVyLCBbc2NoZW1hLCB0YWJsZSwgdHlwZSwgZmllbGRdKTtcblxuICAgICAgICAvLyDlpoLmnpzov5jmsqHmnInms6jlhozov4fvvIzlsLHlkJHmlbDmja7lupPliJvlu7p0cmlnZ2VyXG4gICAgICAgIGlmIChsaXN0ZW5lciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAvLyDkv53lrZjnm5HlkKzlmahcbiAgICAgICAgICAgIGxpc3RlbmVyID0gbmV3IFNldDxGdW5jdGlvbj4oKTtcbiAgICAgICAgICAgIGxpc3RlbmVyLmFkZChjYWxsYmFjayk7XG4gICAgICAgICAgICBfLnNldCh0aGlzLnJlZ2lzdGVyZWRMaXN0ZW5lciwgW3NjaGVtYSwgdGFibGUsIHR5cGUsIGZpZWxkXSwgbGlzdGVuZXIpO1xuXG4gICAgICAgICAgICAvL+WQkeaVsOaNruW6k+WIm+W7ulRyaWdnZXJcbiAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgVHJpZ2dlclR5cGUuaW5zZXJ0OlxuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl90cmlnZ2VyQ3JlYXRvci5jcmVhdGVJbnNlcnRUcmlnZ2VyKHNjaGVtYSwgdGFibGUpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFRyaWdnZXJUeXBlLmRlbGV0ZTpcbiAgICAgICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5fdHJpZ2dlckNyZWF0b3IuY3JlYXRlRGVsZXRlVHJpZ2dlcihzY2hlbWEsIHRhYmxlKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBUcmlnZ2VyVHlwZS51cGRhdGU6XG4gICAgICAgICAgICAgICAgICAgIC8vIOiOt+WPluW3suazqOWGjOi/h+S6hueahOWtl+auteWQjeensFxuICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWVsZHMgPSBPYmplY3Qua2V5cyhfLmdldCh0aGlzLnJlZ2lzdGVyZWRMaXN0ZW5lciwgW3NjaGVtYSwgdGFibGUsIHR5cGVdKSk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RyaWdnZXJDcmVhdG9yLmNyZWF0ZVVwZGF0ZVRyaWdnZXIoc2NoZW1hLCB0YWJsZSwgZmllbGRzKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyDmo4Dmn6XmmK/lkKblt7Lnu4/ms6jlhozov4fkuoZcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lci5oYXMoY2FsbGJhY2spKVxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcign55u45ZCM55qE5Zue6LCD5Ye95pWw6KKr6YeN5aSN5rOo5YaMJyk7XG5cbiAgICAgICAgICAgIC8vIOS/neWtmOebkeWQrOWZqFxuICAgICAgICAgICAgbGlzdGVuZXIuYWRkKGNhbGxiYWNrKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOenu+mZpOS5i+WJjeazqOWGjOeahOebkeWQrOWZqFxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7KGRhdGE6IENoYW5nZWREYXRhKSA9PiB2b2lkfSBjYWxsYmFjayDlj5HnlJ/lj5jljJblkI7opoHmiafooYznmoTlm57osIPlh73mlbBcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gc2NoZW1hIOimgeebkeWQrOeahOaVsOaNruW6k1xuICAgICAqIEBwYXJhbSB7c3RyaW5nfSB0YWJsZSDopoHnm5HlkKznmoTooahcbiAgICAgKiBAcGFyYW0ge1RyaWdnZXJUeXBlfSB0eXBlIOimgeebkeWQrOeahOexu+Wei1xuICAgICAqIEBwYXJhbSB7c3RyaW5nW119IGZpZWxkIOWmguaenOebkeWQrOeahOexu+Wei+aYr3VwZGF0Ze+8jOmCo+S5iOi/mOimgeaMh+WumuimgeebkeWQrOeahOWtl+auteOAglxuICAgICAqL1xuICAgIGFzeW5jIHJlbW92ZShjYWxsYmFjazogKGRhdGE6IENoYW5nZWREYXRhKSA9PiB2b2lkLCBzY2hlbWE6IHN0cmluZywgdGFibGU6IHN0cmluZywgdHlwZTogVHJpZ2dlclR5cGUsIGZpZWxkOiBzdHJpbmcgPSAnXycpIHtcbiAgICAgICAgY29uc3QgbGlzdGVuZXI6IFNldDxGdW5jdGlvbj4gPSBfLmdldCh0aGlzLnJlZ2lzdGVyZWRMaXN0ZW5lciwgW3NjaGVtYSwgdGFibGUsIHR5cGUsIGZpZWxkXSk7XG5cbiAgICAgICAgaWYgKGxpc3RlbmVyICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGxpc3RlbmVyLmRlbGV0ZShjYWxsYmFjayk7XG5cbiAgICAgICAgICAgIC8vIOWmguaenOayoeacieS6huebkeWQrOWZqOWGjeebkeWQrOS6hu+8jOWwsea4hemZpOaVsOaNruW6k+S4reazqOWGjOi/h+eahFRyaWdnZXJcbiAgICAgICAgICAgIGlmIChsaXN0ZW5lci5zaXplID09PSAwKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0OiBhbnkgPSBfLmdldCh0aGlzLnJlZ2lzdGVyZWRMaXN0ZW5lciwgW3NjaGVtYSwgdGFibGUsIHR5cGVdKTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGFyZ2V0W2ZpZWxkXTtcblxuICAgICAgICAgICAgICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIFRyaWdnZXJUeXBlLmluc2VydDpcbiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RyaWdnZXJDcmVhdG9yLnJlbW92ZUluc2VydFRyaWdnZXIoc2NoZW1hLCB0YWJsZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSBUcmlnZ2VyVHlwZS5kZWxldGU6XG4gICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl90cmlnZ2VyQ3JlYXRvci5yZW1vdmVEZWxldGVUcmlnZ2VyKHNjaGVtYSwgdGFibGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgVHJpZ2dlclR5cGUudXBkYXRlOlxuICAgICAgICAgICAgICAgICAgICAgICAgLy8g6I635Y+W5bey5rOo5YaM6L+H5LqG55qE5a2X5q615ZCN56ewXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmaWVsZHMgPSBPYmplY3Qua2V5cyhfLmdldCh0aGlzLnJlZ2lzdGVyZWRMaXN0ZW5lciwgW3NjaGVtYSwgdGFibGUsIHR5cGVdKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZmllbGRzLmxlbmd0aCA9PT0gMClcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLl90cmlnZ2VyQ3JlYXRvci5yZW1vdmVVcGRhdGVUcmlnZ2VyKHNjaGVtYSwgdGFibGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuX3RyaWdnZXJDcmVhdG9yLmNyZWF0ZVVwZGF0ZVRyaWdnZXIoc2NoZW1hLCB0YWJsZSwgZmllbGRzKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIOagueaNruaUtuWIsOeahOaVsOaNruinpuWPkeebuOW6lOeahOebkeWQrOWZqFxuICAgIHByaXZhdGUgX2Rpc3BhdGNoKGRhdGE6IENoYW5nZWREYXRhKTogdm9pZCB7XG4gICAgICAgIC8vIOeUqOS6juinpuWPkeebkeWQrOWZqFxuICAgICAgICBjb25zdCBlbWl0ID0gKGxpc3RlbmVyOiBTZXQ8RnVuY3Rpb24+KSA9PiB7XG4gICAgICAgICAgICBpZiAobGlzdGVuZXIpIHtcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBpdGVtIG9mIGxpc3RlbmVyLnZhbHVlcygpKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0oZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gVHJpZ2dlclR5cGUudXBkYXRlKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpdGVtIG9mIGRhdGEuY2hhbmdlZEZpZWxkcykge1xuICAgICAgICAgICAgICAgIGVtaXQoXy5nZXQodGhpcy5yZWdpc3RlcmVkTGlzdGVuZXIsIFtkYXRhLnNjaGVtYSwgZGF0YS50YWJsZSwgZGF0YS50eXBlLCBpdGVtXSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZW1pdChfLmdldCh0aGlzLnJlZ2lzdGVyZWRMaXN0ZW5lciwgW2RhdGEuc2NoZW1hLCBkYXRhLnRhYmxlLCBkYXRhLnR5cGUsICdfJ10pKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIOajgOafpeimgeWIm+W7uuinpuWPkeWZqOeahOihqOaYr+WQpuWtmOWcqO+8jOS4jeWtmOWcqOWwseaKm+WHuuW8guW4uFxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzY2hlbWEg5pWw5o2u5bqT5ZCNXG4gICAgICogQHBhcmFtIHtTdHJpbmd9IHRhYmxlIOihqOWQjVxuICAgICAqIEBwYXJhbSB7U3RyaW5nfSBmaWVsZCDlrZfmrrXlkI1cbiAgICAgKi9cbiAgICBwcml2YXRlIF9jaGVja190YWJsZV9hbmRfZmllbGRzX2V4aXN0cyhzY2hlbWE6IHN0cmluZywgdGFibGU6IFN0cmluZywgZmllbGQ/OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc3QgdGI6IGFueSA9IF8uZ2V0KHRoaXMuX3RhYmxlSW5mbywgW3NjaGVtYSwgdGFibGVdKTtcblxuICAgICAgICAvL+ajgOafpeaVsOaNruW6k+aYr+WQpuWtmOWcqFxuICAgICAgICBpZiAodGIgPT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGDmlbDmja7lupNbJHtzY2hlbWF9XSDkuIvnmoTooaggWyR7dGFibGV9XSDkuI3lrZjlnKjvvIzml6Dms5XliJvlu7pUcmlnZ2VyYCk7XG4gICAgICAgIH1cblxuICAgICAgICAvL+ajgOafpeebuOWFs+Wtl+auteaYr+WQpuWtmOWcqFxuICAgICAgICBpZiAoZmllbGQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgaWYgKHRiW2ZpZWxkXSAhPT0gdHJ1ZSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihg5pWw5o2u5bqTWyR7c2NoZW1hfV0g5LiL55qE6KGoIFske3RhYmxlfV0g5LiL55qE5a2X5q61IFske2ZpZWxkfV0g5LiN5a2Y5Zyo77yM5peg5rOV5Yib5bu6VHJpZ2dlcmApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufSJdfQ==
