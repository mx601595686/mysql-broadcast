"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const mysql = require("mysql");
const service_starter_1 = require("service-starter");
class MysqlInitializer extends service_starter_1.ServiceModule {
    async onStart() {
        await this.startMysqld();
        await this.checkUDF();
    }
    startMysqld() {
        return new Promise((resolve, reject) => {
            service_starter_1.log.l('正在启动 MySQL Deamon');
            this._mysqld = child_process.spawn('/usr/local/bin/docker-entrypoint.sh', ["mysqld"]);
            this._mysqld.on('error', this.emit.bind(this, 'error'));
            let retry = 0;
            const timer = setInterval(() => {
                if (retry++ < 3) {
                    service_starter_1.log.l(`开始尝试第${retry}次连接mysql`);
                    const con = mysql.createConnection({
                        user: 'root',
                        connectTimeout: 9500,
                        multipleStatements: true,
                        socketPath: '/var/run/mysqld/mysqld.sock'
                    });
                    con.connect((err) => {
                        if (err) {
                            service_starter_1.log.e(`第${retry}次连接失败: `, err);
                        }
                        else {
                            service_starter_1.log.l('MySQL Deamon启动成功！');
                            service_starter_1.log.l('成功连接到MySQL！');
                            this._mysql = con;
                            clearInterval(timer);
                            resolve();
                        }
                    });
                }
                else {
                    clearInterval(timer);
                    reject(new Error('无法连接到MySQL，超过了重试次数'));
                }
            }, 10000);
        });
    }
    checkUDF() {
        return new Promise((resolve, reject) => {
            service_starter_1.log.l('开始检查 mysql-udf-http');
            this._mysql.query("select * from mysql.func where dl = 'mysql-udf-http.so'", (err, result, fields) => {
                if (err) {
                    reject(new Error('检查mysql-udf-http配置时发生异常' + err));
                }
                else if (result.length === 4) {
                    service_starter_1.log.l('mysql-udf-http正常');
                    resolve();
                }
                else {
                    service_starter_1.log.l('开始配置mysql-udf-http');
                    this._mysql.query(`
                        # 删除已有的
                            DROP FUNCTION IF EXISTS http_get;
                            DROP FUNCTION IF EXISTS http_post;
                            DROP FUNCTION IF EXISTS http_put;
                            DROP FUNCTION IF EXISTS http_delete;
                            
                            # 创建
                            create function http_get returns string soname 'mysql-udf-http.so';
                            create function http_post returns string soname 'mysql-udf-http.so';
                            create function http_put returns string soname 'mysql-udf-http.so';
                            create function http_delete returns string soname 'mysql-udf-http.so';
                        `, err => {
                        if (err) {
                            reject(new Error('配置mysql-udf-http失败' + err));
                        }
                        else {
                            service_starter_1.log.l('配置mysql-udf-http完成');
                            resolve();
                        }
                    });
                }
            });
        });
    }
    onStop() {
        return new Promise((resolve, reject) => {
            service_starter_1.log.l('正在终止mysql服务');
            if (this._mysqld === undefined) {
                resolve();
                return;
            }
            if (this._mysql)
                this._mysql.end();
            this._mysqld.kill();
            this._mysqld.once('exit', (err, code) => {
                if (err) {
                    reject(new Error('终止mysql服务失败：' + err));
                }
                else {
                    resolve();
                }
            });
            setTimeout(() => {
                this._mysql = undefined;
                this._mysqld = undefined;
                reject(new Error('终止mysql服务失败：终止超时'));
            }, 5000);
        });
    }
    onHealthChecking() {
        return new Promise((resolve) => {
            this._mysql.query('select 1', (err) => {
                if (err) {
                    resolve(service_starter_1.HealthStatus.unhealthy);
                }
                else {
                    resolve(service_starter_1.HealthStatus.success);
                }
            });
        });
    }
    getConnection() {
        return this._mysql;
    }
}
exports.default = MysqlInitializer;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk15c3FsSW5pdGlhbGl6ZXIvTXlzcWxJbml0aWFsaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtDQUFnRDtBQUNoRCwrQkFBZ0M7QUFDaEMscURBQW1FO0FBTW5FLHNCQUFzQyxTQUFRLCtCQUFhO0lBT3ZELEtBQUssQ0FBQyxPQUFPO1FBQ1QsTUFBTSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDekIsTUFBTSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUdPLFdBQVc7UUFDZixNQUFNLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTTtZQUMvQixxQkFBRyxDQUFDLENBQUMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBRTNCLElBQUksQ0FBQyxPQUFPLEdBQUcsYUFBYSxDQUFDLEtBQUssQ0FBQyxxQ0FBcUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDdEYsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBV3hELElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztZQUVkLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQztnQkFFdEIsRUFBRSxDQUFDLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDZCxxQkFBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLEtBQUssVUFBVSxDQUFDLENBQUM7b0JBRy9CLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQzt3QkFDL0IsSUFBSSxFQUFFLE1BQU07d0JBQ1osY0FBYyxFQUFFLElBQUk7d0JBQ3BCLGtCQUFrQixFQUFFLElBQUk7d0JBQ3hCLFVBQVUsRUFBRSw2QkFBNkI7cUJBQzVDLENBQUMsQ0FBQztvQkFFSCxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMs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RyxFQUFFLElBQUk7Z0JBQ2hDLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ04sTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLGNBQWMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFBO2dCQUMzQyxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sRUFBRSxDQUFDO2dCQUNkLENBQUM7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUVILFVBQVUsQ0FBQztnQkFDTixJQUFJLENBQUMsTUFBYyxHQUFHLFNBQVMsQ0FBQztnQkFDaEMsSUFBSSxDQUFDLE9BQWUsR0FBRyxTQUFTLENBQUM7Z0JBRWxDLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7WUFDMUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2IsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBR0QsZ0JBQWdCO1FBQ1osTUFBTSxDQUFDLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTztZQUN2QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsQ0FBQyxHQUFHO2dCQUM5QixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUNOLE9BQU8sQ0FBQyw4QkFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNwQyxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUNKLE9BQU8sQ0FBQyw4QkFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUNsQyxDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUE7UUFDTixDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFRRCxhQUFhO1FBQ1QsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDdkIsQ0FBQztDQUNKO0FBOUpELG1DQThKQyIsImZpbGUiOiJNeXNxbEluaXRpYWxpemVyL015c3FsSW5pdGlhbGl6ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hpbGRfcHJvY2VzcyA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKTtcbmltcG9ydCBteXNxbCA9IHJlcXVpcmUoJ215c3FsJyk7XG5pbXBvcnQgeyBsb2csIFNlcnZpY2VNb2R1bGUsIEhlYWx0aFN0YXR1cyB9IGZyb20gXCJzZXJ2aWNlLXN0YXJ0ZXJcIjtcblxuLyoqXG4gKiBNeVNRTOWIneWni+WMluWZqCAgICAgXG4gKiDlkK/liqhNeVNRTCBEZWFtb27vvIzliJvlu7rkuI5NeVNRTOeahOi/nuaOpeOAguajgOafpW15c3FsLXVkZi1odHRwLnNv5o+S5Lu2XG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE15c3FsSW5pdGlhbGl6ZXIgZXh0ZW5kcyBTZXJ2aWNlTW9kdWxlIHtcblxuICAgIC8vTXlTUUwgRGVhbW9u6L+b56iLXG4gICAgcHJpdmF0ZSBfbXlzcWxkOiBjaGlsZF9wcm9jZXNzLkNoaWxkUHJvY2VzcztcbiAgICAvL+S4jk15U1FM55qE6L+e5o6lXG4gICAgcHJpdmF0ZSBfbXlzcWw6IG15c3FsLklDb25uZWN0aW9uO1xuXG4gICAgYXN5bmMgb25TdGFydCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdGFydE15c3FsZCgpO1xuICAgICAgICBhd2FpdCB0aGlzLmNoZWNrVURGKCk7XG4gICAgfVxuXG4gICAgLy8g5ZCv5YqoTXlTUUwgRGVhbW9uXG4gICAgcHJpdmF0ZSBzdGFydE15c3FsZCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGxvZy5sKCfmraPlnKjlkK/liqggTXlTUUwgRGVhbW9uJyk7XG5cbiAgICAgICAgICAgIHRoaXMuX215c3FsZCA9IGNoaWxkX3Byb2Nlc3Muc3Bhd24oJy91c3IvbG9jYWwvYmluL2RvY2tlci1lbnRyeXBvaW50LnNoJywgW1wibXlzcWxkXCJdKTtcbiAgICAgICAgICAgIHRoaXMuX215c3FsZC5vbignZXJyb3InLCB0aGlzLmVtaXQuYmluZCh0aGlzLCAnZXJyb3InKSk7XG5cbiAgICAgICAgICAgIC8vIOeUqOS6jua1i+ivleaJk+WNsFxuICAgICAgICAgICAgLyogdGhpcy5fbXlzcWxkLnN0ZG91dC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nLmwoYG15c3FsZC1zdGRvdXQ6ICR7ZGF0YX1gKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5fbXlzcWxkLnN0ZGVyci5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nLmwoYG15c3FsZC1zdGRlcnI6ICR7ZGF0YX1gKTtcbiAgICAgICAgICAgIH0pOyAqL1xuXG4gICAgICAgICAgICAvL+WwneivleasoeaVsFxuICAgICAgICAgICAgbGV0IHJldHJ5ID0gMDtcblxuICAgICAgICAgICAgY29uc3QgdGltZXIgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgLy/mnIDlpJrlsJ3or5Uz5qyhXG4gICAgICAgICAgICAgICAgaWYgKHJldHJ5KysgPCAzKSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZy5sKGDlvIDlp4vlsJ3or5XnrKwke3JldHJ5feasoei/nuaOpW15c3FsYCk7XG5cbiAgICAgICAgICAgICAgICAgICAgLy8g5Yib5bu66L+e5o6lXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbiA9IG15c3FsLmNyZWF0ZUNvbm5lY3Rpb24oe1xuICAgICAgICAgICAgICAgICAgICAgICAgdXNlcjogJ3Jvb3QnLFxuICAgICAgICAgICAgICAgICAgICAgICAgY29ubmVjdFRpbWVvdXQ6IDk1MDAsXG4gICAgICAgICAgICAgICAgICAgICAgICBtdWx0aXBsZVN0YXRlbWVudHM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgICAgICBzb2NrZXRQYXRoOiAnL3Zhci9ydW4vbXlzcWxkL215c3FsZC5zb2NrJ1xuICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICBjb24uY29ubmVjdCgoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmUoYOesrCR7cmV0cnl95qyh6L+e5o6l5aSx6LSlOiBgLCBlcnIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cubCgnTXlTUUwgRGVhbW9u5ZCv5Yqo5oiQ5Yqf77yBJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmwoJ+aIkOWKn+i/nuaOpeWIsE15U1FM77yBJyk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+S/neWtmOi/nuaOpVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX215c3FsID0gY29uO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLy/nu5HlrprplJnor6/kuovku7bnm5HlkKxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMuX215c3FsLm9uKCdlcnJvcicsIHRoaXMuZW1pdC5iaW5kKHRoaXMsICdlcnJvcicpKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ+aXoOazlei/nuaOpeWIsE15U1FM77yM6LaF6L+H5LqG6YeN6K+V5qyh5pWwJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDEwMDAwKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy/mo4Dmn6VteXNxbC11ZGYtaHR0cOaWueazleaYr+WQpuW3sue7j+ato+ehruWuieijheS6hlxuICAgIHByaXZhdGUgY2hlY2tVREYoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBsb2cubCgn5byA5aeL5qOA5p+lIG15c3FsLXVkZi1odHRwJyk7XG5cbiAgICAgICAgICAgIHRoaXMuX215c3FsLnF1ZXJ5KFwic2VsZWN0ICogZnJvbSBteXNxbC5mdW5jIHdoZXJlIGRsID0gJ215c3FsLXVkZi1odHRwLnNvJ1wiLCAoZXJyLCByZXN1bHQsIGZpZWxkcykgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcign5qOA5p+lbXlzcWwtdWRmLWh0dHDphY3nva7ml7blj5HnlJ/lvILluLgnICsgZXJyKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2UgaWYgKHJlc3VsdC5sZW5ndGggPT09IDQpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLmwoJ215c3FsLXVkZi1odHRw5q2j5bi4Jyk7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBsb2cubCgn5byA5aeL6YWN572ubXlzcWwtdWRmLWh0dHAnKTtcblxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9teXNxbC5xdWVyeShgXG4gICAgICAgICAgICAgICAgICAgICAgICAjIOWIoOmZpOW3suacieeahFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIERST1AgRlVOQ1RJT04gSUYgRVhJU1RTIGh0dHBfZ2V0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIERST1AgRlVOQ1RJT04gSUYgRVhJU1RTIGh0dHBfcG9zdDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBEUk9QIEZVTkNUSU9OIElGIEVYSVNUUyBodHRwX3B1dDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBEUk9QIEZVTkNUSU9OIElGIEVYSVNUUyBodHRwX2RlbGV0ZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIOWIm+W7ulxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZSBmdW5jdGlvbiBodHRwX2dldCByZXR1cm5zIHN0cmluZyBzb25hbWUgJ215c3FsLXVkZi1odHRwLnNvJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGUgZnVuY3Rpb24gaHR0cF9wb3N0IHJldHVybnMgc3RyaW5nIHNvbmFtZSAnbXlzcWwtdWRmLWh0dHAuc28nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZSBmdW5jdGlvbiBodHRwX3B1dCByZXR1cm5zIHN0cmluZyBzb25hbWUgJ215c3FsLXVkZi1odHRwLnNvJztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGUgZnVuY3Rpb24gaHR0cF9kZWxldGUgcmV0dXJucyBzdHJpbmcgc29uYW1lICdteXNxbC11ZGYtaHR0cC5zbyc7XG4gICAgICAgICAgICAgICAgICAgICAgICBgLCBlcnIgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcign6YWN572ubXlzcWwtdWRmLWh0dHDlpLHotKUnICsgZXJyKSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nLmwoJ+mFjee9rm15c3FsLXVkZi1odHRw5a6M5oiQJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8g57uI5q2ibXlzcWwg6L+Q6KGMXG4gICAgb25TdG9wKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbG9nLmwoJ+ato+WcqOe7iOatom15c3Fs5pyN5YqhJyk7XG4gICAgICAgICAgICBpZiAodGhpcy5fbXlzcWxkID09PSB1bmRlZmluZWQpIHsgcmVzb2x2ZSgpOyByZXR1cm47IH1cblxuICAgICAgICAgICAgaWYgKHRoaXMuX215c3FsKSB0aGlzLl9teXNxbC5lbmQoKTtcblxuICAgICAgICAgICAgdGhpcy5fbXlzcWxkLmtpbGwoKTtcblxuICAgICAgICAgICAgdGhpcy5fbXlzcWxkLm9uY2UoJ2V4aXQnLCAoZXJyLCBjb2RlKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCfnu4jmraJteXNxbOacjeWKoeWksei0pe+8micgKyBlcnIpKVxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgKHRoaXMuX215c3FsIGFzIGFueSkgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgKHRoaXMuX215c3FsZCBhcyBhbnkpID0gdW5kZWZpbmVkO1xuXG4gICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcign57uI5q2ibXlzcWzmnI3liqHlpLHotKXvvJrnu4jmraLotoXml7YnKSk7XG4gICAgICAgICAgICB9LCA1MDAwKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy/lgaXlurfmo4Dmn6VcbiAgICBvbkhlYWx0aENoZWNraW5nKCk6IFByb21pc2U8SGVhbHRoU3RhdHVzPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fbXlzcWwucXVlcnkoJ3NlbGVjdCAxJywgKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShIZWFsdGhTdGF0dXMudW5oZWFsdGh5KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKEhlYWx0aFN0YXR1cy5zdWNjZXNzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiDojrflj5ZteXNxbOi/nuaOpVxuICAgICAqIFxuICAgICAqIEByZXR1cm5zIFxuICAgICAqIEBtZW1iZXJvZiBNeXNxbEluaXRpYWxpemVyXG4gICAgICovXG4gICAgZ2V0Q29ubmVjdGlvbigpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX215c3FsO1xuICAgIH1cbn0iXX0=
