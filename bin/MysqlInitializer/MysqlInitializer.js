"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const child_process = require("child_process");
const service_starter_1 = require("service-starter");
class MysqlInitializer extends service_starter_1.ServiceModule {
    async onStart() {
        await this.startMysqld();
    }
    startMysqld() {
        return new Promise((resolve, reject) => {
            service_starter_1.log.l('正在启动 MySQL Deamon');
            this._mysqld = child_process.spawn('/usr/local/bin/docker-entrypoint.sh', ["mysqld"]);
            this._mysqld.on('error', this.emit.bind(this, 'error'));
            resolve();
            this._mysqld.stdout.on('data', (data) => {
                service_starter_1.log.l(`mysqld-out: ${data}`);
            });
            this._mysqld.stderr.on('data', (data) => {
            });
        });
    }
    checkUDF() {
        return new Promise((resolve, reject) => {
            service_starter_1.log.l('开始检查 mysql-udf-http');
            this._mysql.query("select * from mysql.func where dl = 'mysql-udf-http.so'", (err, result, fields) => {
                if (err) {
                    reject(new Error('检查mysql-udf-http配置时发生异常' + err));
                }
                else if (result.length === 4) {
                    service_starter_1.log.l('mysql-udf-http正常');
                    resolve();
                }
                else {
                    service_starter_1.log.l('开始配置mysql-udf-http');
                    this._mysql.query(`
                        # 删除已有的
                            DROP FUNCTION IF EXISTS http_get;
                            DROP FUNCTION IF EXISTS http_post;
                            DROP FUNCTION IF EXISTS http_put;
                            DROP FUNCTION IF EXISTS http_delete;
                            
                            # 创建
                            create function http_get returns string soname 'mysql-udf-http.so';
                            create function http_post returns string soname 'mysql-udf-http.so';
                            create function http_put returns string soname 'mysql-udf-http.so';
                            create function http_delete returns string soname 'mysql-udf-http.so';
                        `, err => {
                        if (err) {
                            reject(new Error('配置mysql-udf-http失败' + err));
                        }
                        else {
                            service_starter_1.log.l('配置mysql-udf-http完成');
                            resolve();
                        }
                    });
                }
            });
        });
    }
    onStop() {
        return new Promise((resolve, reject) => {
            service_starter_1.log.l('正在终止mysql服务');
            if (this._mysqld === undefined) {
                resolve();
                return;
            }
            if (this._mysql)
                this._mysql.end();
            this._mysqld.kill();
            this._mysqld.once('exit', (err, code) => {
                if (err) {
                    reject(new Error('终止mysql服务失败：' + err));
                }
                else {
                    resolve();
                }
            });
            setTimeout(() => {
                this._mysql = undefined;
                this._mysqld = undefined;
                reject(new Error('终止mysql服务失败：终止超时'));
            }, 5000);
        });
    }
    onHealthChecking() {
        return new Promise((resolve, reject) => {
            this._mysql.query('select 1', (err) => {
                if (err) {
                    reject(err);
                }
                else {
                    resolve();
                }
            });
        });
    }
    getConnection() {
        return this._mysql;
    }
}
exports.default = MysqlInitializer;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk15c3FsSW5pdGlhbGl6ZXIvTXlzcWxJbml0aWFsaXplci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLCtDQUFnRDtBQUVoRCxxREFBcUQ7QUFNckQsc0JBQXNDLFNBQVEsK0JBQWE7SUFPdkQsS0FBSyxDQUFDLE9BQU87UUFDVCxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUU3QixDQUFDO0lBR08sV0FBVztRQUNmLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNO1lBQy9CLHFCQUFHLENBQUMsQ0FBQyxDQUFDLG1CQUFtQixDQUFDLENBQUM7WUFFM0IsSUFBSSxDQUFDLE9BQU8sR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLHFDQUFxQyxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztZQUN0RixJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDeEQsT0FBTyxFQUFFLENBQUM7WUFFVixJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSTtnQkFDaEMscUJBQUcsQ0FBQyxDQUFDLENBQUMsZUFBZSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ2pDLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUk7WUFFcEMsQ0FBQyxDQUFDLENBQUM7UUF3Q1AsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBR08sUUFBUTtRQUNaLE1BQU0sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNO1lBQy9CLHFCQUFHLENBQUMsQ0FBQyxDQUFDLHFCQUFxQixDQUFDLENBQUM7WUFFN0IsSUFBSSxDQUFDLE1BQU0s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QUFDLENBQUMsQ0FBQTtRQUNOLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQVFELGFBQWE7UUFDVCxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN2QixDQUFDO0NBQ0o7QUE5SkQsbUNBOEpDIiwiZmlsZSI6Ik15c3FsSW5pdGlhbGl6ZXIvTXlzcWxJbml0aWFsaXplci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGlsZF9wcm9jZXNzID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuaW1wb3J0IG15c3FsID0gcmVxdWlyZSgnbXlzcWwnKTtcbmltcG9ydCB7IGxvZywgU2VydmljZU1vZHVsZSB9IGZyb20gXCJzZXJ2aWNlLXN0YXJ0ZXJcIjtcblxuLyoqXG4gKiBNeVNRTOWIneWni+WMluWZqCAgICAgXG4gKiDlkK/liqhNeVNRTCBEZWFtb27vvIzliJvlu7rkuI5NeVNRTOeahOi/nuaOpeOAguajgOafpW15c3FsLXVkZi1odHRwLnNv5o+S5Lu2XG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE15c3FsSW5pdGlhbGl6ZXIgZXh0ZW5kcyBTZXJ2aWNlTW9kdWxlIHtcblxuICAgIC8vTXlTUUwgRGVhbW9u6L+b56iLXG4gICAgcHJpdmF0ZSBfbXlzcWxkOiBjaGlsZF9wcm9jZXNzLkNoaWxkUHJvY2VzcztcbiAgICAvL+S4jk15U1FM55qE6L+e5o6lXG4gICAgcHJpdmF0ZSBfbXlzcWw6IG15c3FsLklDb25uZWN0aW9uO1xuXG4gICAgYXN5bmMgb25TdGFydCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgYXdhaXQgdGhpcy5zdGFydE15c3FsZCgpO1xuICAgICAgICAvL2F3YWl0IHRoaXMuY2hlY2tVREYoKTtcbiAgICB9XG5cbiAgICAvLyDlkK/liqhNeVNRTCBEZWFtb25cbiAgICBwcml2YXRlIHN0YXJ0TXlzcWxkKCk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgbG9nLmwoJ+ato+WcqOWQr+WKqCBNeVNRTCBEZWFtb24nKTtcblxuICAgICAgICAgICAgdGhpcy5fbXlzcWxkID0gY2hpbGRfcHJvY2Vzcy5zcGF3bignL3Vzci9sb2NhbC9iaW4vZG9ja2VyLWVudHJ5cG9pbnQuc2gnLCBbXCJteXNxbGRcIl0pO1xuICAgICAgICAgICAgdGhpcy5fbXlzcWxkLm9uKCdlcnJvcicsIHRoaXMuZW1pdC5iaW5kKHRoaXMsICdlcnJvcicpKTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICAgIC8vIOeUqOS6jua1i+ivleaJk+WNsFxuICAgICAgICAgICAgdGhpcy5fbXlzcWxkLnN0ZG91dC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgbG9nLmwoYG15c3FsZC1vdXQ6ICR7ZGF0YX1gKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5fbXlzcWxkLnN0ZGVyci5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgLy9sb2cubChgbXlzcWxkLWVycjogJHtkYXRhfWApO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8v5bCd6K+V5qyh5pWwXG4gICAgICAgICAvKiAgICBsZXQgcmV0cnkgPSAwO1xuXG4gICAgICAgICAgICBjb25zdCB0aW1lciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICAgICAgICAvL+acgOWkmuWwneivlTPmrKFcbiAgICAgICAgICAgICAgICBpZiAocmV0cnkrKyA8IDMpIHtcbiAgICAgICAgICAgICAgICAgICAgbG9nLmwoYOW8gOWni+WwneivleesrCR7cmV0cnl95qyh6L+e5o6lbXlzcWxgKTtcblxuICAgICAgICAgICAgICAgICAgICAvLyDliJvlu7rov57mjqVcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29uID0gbXlzcWwuY3JlYXRlQ29ubmVjdGlvbih7XG4gICAgICAgICAgICAgICAgICAgICAgICB1c2VyOiAncm9vdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25uZWN0VGltZW91dDogOTUwMCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG11bHRpcGxlU3RhdGVtZW50czogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNvY2tldFBhdGg6ICcvdmFyL3J1bi9teXNxbGQvbXlzcWxkLnNvY2snXG4gICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgIGNvbi5jb25uZWN0KChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cuZShg56ysJHtyZXRyeX3mrKHov57mjqXlpLHotKU6IGAsIGVycik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZy5sKCdNeVNRTCBEZWFtb27lkK/liqjmiJDlip/vvIEnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cubCgn5oiQ5Yqf6L+e5o6l5YiwTXlTUUzvvIEnKTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8v5L+d5a2Y6L+e5o6lXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbXlzcWwgPSBjb247XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL+e7keWumumUmeivr+S6i+S7tuebkeWQrFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vdGhpcy5fbXlzcWwub24oJ2Vycm9yJywgdGhpcy5lbWl0LmJpbmQodGhpcywgJ2Vycm9yJykpO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBjbGVhckludGVydmFsKHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcign5peg5rOV6L+e5o6l5YiwTXlTUUzvvIzotoXov4fkuobph43or5XmrKHmlbAnKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSwgMTAwMDApOyAqL1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvL+ajgOafpW15c3FsLXVkZi1odHRw5pa55rOV5piv5ZCm5bey57uP5q2j56Gu5a6J6KOF5LqGXG4gICAgcHJpdmF0ZSBjaGVja1VERigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgIGxvZy5sKCflvIDlp4vmo4Dmn6UgbXlzcWwtdWRmLWh0dHAnKTtcblxuICAgICAgICAgICAgdGhpcy5fbXlzcWwucXVlcnkoXCJzZWxlY3QgKiBmcm9tIG15c3FsLmZ1bmMgd2hlcmUgZGwgPSAnbXlzcWwtdWRmLWh0dHAuc28nXCIsIChlcnIsIHJlc3VsdCwgZmllbGRzKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCfmo4Dmn6VteXNxbC11ZGYtaHR0cOmFjee9ruaXtuWPkeeUn+W8guW4uCcgKyBlcnIpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocmVzdWx0Lmxlbmd0aCA9PT0gNCkge1xuICAgICAgICAgICAgICAgICAgICBsb2cubCgnbXlzcWwtdWRmLWh0dHDmraPluLgnKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIGxvZy5sKCflvIDlp4vphY3nva5teXNxbC11ZGYtaHR0cCcpO1xuXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX215c3FsLnF1ZXJ5KGBcbiAgICAgICAgICAgICAgICAgICAgICAgICMg5Yig6Zmk5bey5pyJ55qEXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgRFJPUCBGVU5DVElPTiBJRiBFWElTVFMgaHR0cF9nZXQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgRFJPUCBGVU5DVElPTiBJRiBFWElTVFMgaHR0cF9wb3N0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIERST1AgRlVOQ1RJT04gSUYgRVhJU1RTIGh0dHBfcHV0O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIERST1AgRlVOQ1RJT04gSUYgRVhJU1RTIGh0dHBfZGVsZXRlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICMg5Yib5bu6XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlIGZ1bmN0aW9uIGh0dHBfZ2V0IHJldHVybnMgc3RyaW5nIHNvbmFtZSAnbXlzcWwtdWRmLWh0dHAuc28nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZSBmdW5jdGlvbiBodHRwX3Bvc3QgcmV0dXJucyBzdHJpbmcgc29uYW1lICdteXNxbC11ZGYtaHR0cC5zbyc7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY3JlYXRlIGZ1bmN0aW9uIGh0dHBfcHV0IHJldHVybnMgc3RyaW5nIHNvbmFtZSAnbXlzcWwtdWRmLWh0dHAuc28nO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZSBmdW5jdGlvbiBodHRwX2RlbGV0ZSByZXR1cm5zIHN0cmluZyBzb25hbWUgJ215c3FsLXVkZi1odHRwLnNvJztcbiAgICAgICAgICAgICAgICAgICAgICAgIGAsIGVyciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCfphY3nva5teXNxbC11ZGYtaHR0cOWksei0pScgKyBlcnIpKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2cubCgn6YWN572ubXlzcWwtdWRmLWh0dHDlrozmiJAnKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyDnu4jmraJteXNxbCDov5DooYxcbiAgICBvblN0b3AoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICBsb2cubCgn5q2j5Zyo57uI5q2ibXlzcWzmnI3liqEnKTtcbiAgICAgICAgICAgIGlmICh0aGlzLl9teXNxbGQgPT09IHVuZGVmaW5lZCkgeyByZXNvbHZlKCk7IHJldHVybjsgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy5fbXlzcWwpIHRoaXMuX215c3FsLmVuZCgpO1xuXG4gICAgICAgICAgICB0aGlzLl9teXNxbGQua2lsbCgpO1xuXG4gICAgICAgICAgICB0aGlzLl9teXNxbGQub25jZSgnZXhpdCcsIChlcnIsIGNvZGUpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ+e7iOatom15c3Fs5pyN5Yqh5aSx6LSl77yaJyArIGVycikpXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAodGhpcy5fbXlzcWwgYXMgYW55KSA9IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICAodGhpcy5fbXlzcWxkIGFzIGFueSkgPSB1bmRlZmluZWQ7XG5cbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKCfnu4jmraJteXNxbOacjeWKoeWksei0pe+8mue7iOatoui2heaXticpKTtcbiAgICAgICAgICAgIH0sIDUwMDApO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvL+WBpeW6t+ajgOafpVxuICAgIG9uSGVhbHRoQ2hlY2tpbmcoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLl9teXNxbC5xdWVyeSgnc2VsZWN0IDEnLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICog6I635Y+WbXlzcWzov57mjqVcbiAgICAgKiBcbiAgICAgKiBAcmV0dXJucyBcbiAgICAgKiBAbWVtYmVyb2YgTXlzcWxJbml0aWFsaXplclxuICAgICAqL1xuICAgIGdldENvbm5lY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB0aGlzLl9teXNxbDtcbiAgICB9XG59Il19
